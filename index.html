<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>ğŸ” Test El Toque â€“ Tasas de cambio</title>
<style>
  body { font-family: monospace; background: #0d1117; color: #c9d1d9; padding: 20px; }
  h1 { color: #58a6ff; }
  .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 16px; margin: 12px 0; }
  .ok  { color: #3fb950; }
  .err { color: #f85149; }
  .warn { color: #d29922; }
  table { border-collapse: collapse; width: 100%; }
  td, th { border: 1px solid #30363d; padding: 8px 12px; text-align: left; }
  th { color: #58a6ff; }
  .highlight { background: #1f2937; font-weight: bold; }
  pre { overflow-x: auto; background: #0d1117; padding: 12px; border-radius: 6px; font-size: 12px; max-height: 300px; overflow-y: auto; }
  button { background: #238636; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; margin: 4px; }
  button:hover { background: #2ea043; }
  #log { color: #8b949e; font-size: 12px; }
</style>
</head>
<body>
<h1>ğŸ” DiagnÃ³stico â€“ Tasas de cambio El Toque</h1>
<p>Este test compara <strong>avg vs median</strong> para EUR/ECU, y muestra los valores crudos del JSON de El Toque.</p>

<button onclick="runTest()">â–¶ Ejecutar test ahora</button>
<button onclick="clearLog()">ğŸ—‘ Limpiar log</button>

<div class="card" id="resultado">
  <em>Haz clic en "Ejecutar test" para comenzarâ€¦</em>
</div>

<div class="card">
  <strong>ğŸ“‹ Log detallado:</strong>
  <pre id="log"></pre>
</div>

<div class="card" id="raw-stats" style="display:none">
  <strong>ğŸ“¦ statistics RAW (del __NEXT_DATA__):</strong>
  <pre id="raw-json"></pre>
</div>

<script>
const proxies = [
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
];

const TARGET = "https://eltoque.com/tasas-de-cambio-cuba";

function log(msg, cls='') {
  const pre = document.getElementById('log');
  const ts = new Date().toLocaleTimeString('es-ES');
  pre.innerHTML += `<span class="${cls}">[${ts}] ${msg}</span>\n`;
  pre.scrollTop = pre.scrollHeight;
}

function clearLog() {
  document.getElementById('log').innerHTML = '';
  document.getElementById('resultado').innerHTML = '<em>Log limpiado.</em>';
  document.getElementById('raw-stats').style.display = 'none';
}

async function fetchViaProxy(targetUrl, proxyFn) {
  const proxyUrl = proxyFn(targetUrl);
  const shortProxy = proxyUrl.slice(0, 45);
  log(`â³ Intentando proxy: ${shortProxy}...`);
  const res = await fetch(proxyUrl, { signal: AbortSignal.timeout(12000) });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  return await res.text();
}

function extractStats(html) {
  const match = html.match(/<script id="__NEXT_DATA__"[^>]*>([\s\S]*?)<\/script>/);
  if (!match) throw new Error("__NEXT_DATA__ no encontrado en el HTML");
  const json = JSON.parse(match[1]);
  const stats = json?.props?.pageProps?.trmiExchange?.data?.api?.statistics;
  if (!stats) throw new Error("trmiExchange.data.api.statistics no encontrado");
  return stats;
}

async function fetchFromYadio() {
  log("â³ Consultando Yadio.io como fallback...", "warn");
  const res = await fetch("https://api.yadio.io/exrates/CUP", { signal: AbortSignal.timeout(8000) });
  if (!res.ok) throw new Error(`Yadio HTTP ${res.status}`);
  const j = await res.json();
  return {
    usd: j.CUP?.USD ? Math.round(1 / j.CUP.USD) : null,
    eur: j.CUP?.EUR ? Math.round(1 / j.CUP.EUR) : null,
    mlc: null,
    source: "Yadio.io"
  };
}

async function runTest() {
  document.getElementById('resultado').innerHTML = '<em>â³ Ejecutandoâ€¦</em>';
  document.getElementById('raw-stats').style.display = 'none';
  log("â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  log("ğŸš€ Iniciando test de tasas El Toque");

  let html = null;
  let proxyUsed = null;

  for (let i = 0; i < proxies.length; i++) {
    try {
      html = await fetchViaProxy(TARGET, proxies[i]);
      proxyUsed = i === 0 ? "allorigins.win" : "codetabs.com";
      log(`âœ… Proxy ${i+1} OK (${proxyUsed}), HTML: ${html.length} chars`, "ok");
      break;
    } catch(e) {
      log(`âŒ Proxy ${i+1} fallÃ³: ${e.message}`, "err");
    }
  }

  if (!html) {
    log("âš ï¸ Todos los proxies fallaron, usando Yadio como fallback...", "warn");
    try {
      const y = await fetchFromYadio();
      showResult(y, "âš ï¸ Fallback Yadio.io (sin MLC)", null);
    } catch(e) {
      log(`âŒ Yadio tambiÃ©n fallÃ³: ${e.message}`, "err");
      document.getElementById('resultado').innerHTML = '<span class="err">âŒ Todos los mÃ©todos fallaron. Revisa la consola del navegador (F12).</span>';
    }
    return;
  }

  let stats;
  try {
    stats = extractStats(html);
    log("âœ… __NEXT_DATA__ extraÃ­do correctamente", "ok");
  } catch(e) {
    log(`âŒ Error parseando datos: ${e.message}`, "err");
    document.getElementById('resultado').innerHTML = `<span class="err">âŒ ${e.message}</span>`;
    return;
  }

  // Mostrar JSON crudo de las monedas relevantes
  const relevantStats = { USD: stats.USD, ECU: stats.ECU, MLC: stats.MLC };
  document.getElementById('raw-json').textContent = JSON.stringify(relevantStats, null, 2);
  document.getElementById('raw-stats').style.display = 'block';

  // Comparar avg vs median para cada moneda
  const currencies = [
    { key: 'USD', label: 'ğŸ’µ USD', symbol: 'USD' },
    { key: 'ECU', label: 'ğŸ’¶ EUR (ECU)', symbol: 'EUR' },
    { key: 'MLC', label: 'ğŸ’³ MLC', symbol: 'MLC' },
  ];

  log("â”€â”€â”€ ComparaciÃ³n avg vs median â”€â”€â”€");
  let tableRows = '';
  for (const cur of currencies) {
    const s = stats[cur.key];
    if (!s) {
      log(`âš ï¸ ${cur.key}: no encontrado en statistics`, "warn");
      tableRows += `<tr><td>${cur.label}</td><td colspan="4" class="err">No disponible</td></tr>`;
      continue;
    }
    const avg    = s.avg    != null ? s.avg.toFixed(2)    : 'N/A';
    const median = s.median != null ? s.median.toFixed(2) : 'N/A';
    const q1     = s.q1     != null ? s.q1.toFixed(2)     : 'N/A';
    const q3     = s.q3     != null ? s.q3.toFixed(2)     : 'N/A';

    const diff = s.avg != null && s.median != null ? (s.avg - s.median).toFixed(2) : 'N/A';
    const diffCls = Math.abs(parseFloat(diff)) > 5 ? 'err' : 'ok';

    log(`${cur.key}: avg=${avg} | median=${median} | diff=${diff}`, diffCls);

    tableRows += `
      <tr>
        <td>${cur.label}</td>
        <td class="warn">${avg}</td>
        <td class="ok highlight">${median}</td>
        <td>${q1} â€“ ${q3}</td>
        <td class="${diffCls}">${diff}</td>
      </tr>`;
  }

  const usd = stats.USD?.median != null ? Math.round(stats.USD.median) : '?';
  const eur_avg    = stats.ECU?.avg    != null ? Math.round(stats.ECU.avg)    : '?';
  const eur_median = stats.ECU?.median != null ? Math.round(stats.ECU.median) : '?';
  const mlc = stats.MLC?.median != null ? Math.round(stats.MLC.median) : '?';

  document.getElementById('resultado').innerHTML = `
    <h2>âœ… Resultado (proxy: ${proxyUsed})</h2>
    <table>
      <tr><th>Moneda</th><th>avg (âŒ antes)</th><th>median (âœ… correcto)</th><th>Rango (q1â€“q3)</th><th>Diferencia</th></tr>
      ${tableRows}
    </table>
    <br>
    <div class="ok">
      âœ… <strong>Valores correctos a mostrar en la web:</strong><br>
      ğŸ’µ USD: <strong>${usd}</strong> CUP<br>
      ğŸ’¶ EUR: <strong>${eur_median}</strong> CUP &nbsp;(con avg serÃ­an ${eur_avg} â€” ese era el bug)<br>
      ğŸ’³ MLC: <strong>${mlc}</strong> CUP
    </div>
  `;
  log("âœ… Test completado", "ok");
}
</script>
</body>
</html>

