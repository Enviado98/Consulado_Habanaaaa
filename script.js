// script.js - LÃ“GICA PRINCIPAL OPTIMIZADA
const SUPABASE_URL="https://ekkaagqovdmcdexrjosh.supabase.co",SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVra2FhZ3FvdmRtY2RleHJqb3NoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NjU2NTEsImV4cCI6MjA3NTQ0MTY1MX0.mmVl7C0Hkzrjoks7snvHWMYk-ksSXkUWzVexhtkozRA";
const API_URL="https://tasas.eltoque.com/v1/trmi",API_TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJmcmVzaCI6ZmFsc2UsImlhdCI6MTc2MzU4NDg4MCwianRpIjoiZmVhZTc2Y2YtODc4Yy00MjdmLTg5MGUtMmQ4MzRmOGE1MzAyIiwidHlwZSI6ImFjY2VzcyIsInN1YiI6IjY5MWUyNWI3ZTkyYmU3N2VhM2RlMjE0ZSIsIm5iZiI6MTc2MzU4NDg4MCwiZXhwIjoxNzk1MTIwODgwfQ.qpxiSsg8ptDTYsXZPnnxC694lUoWmT1qyAvzLUfl1-8";
const CACHE_MS=6e5,RECENT_MS=864e5,OLD_MS=6048e5,PANEL_MS=2e3;
import{createClient}from'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabase=createClient(SUPABASE_URL,SUPABASE_KEY);
let admin=!1,currentData=[],currentNews=[],status={deficit_mw:"...",dollar_cup:"...",euro_cup:"...",divisa_edited_at:null};
let userWebId=localStorage.getItem("userWebId");userWebId||(userWebId=crypto.randomUUID(),localStorage.setItem("userWebId",userWebId));
const DOM={body:document.body,cont:document.getElementById("contenedor"),news:document.getElementById("newsTicker"),newsC:document.getElementById("newsTickerContent"),commC:document.getElementById("commentsContainer"),cName:document.getElementById("commenterName"),cText:document.getElementById("commentText"),pubBtn:document.getElementById("publishCommentBtn"),adminP:document.getElementById("adminControlsPanel"),msg:document.getElementById("statusMessage"),admBtn:document.getElementById("toggleAdminBtn"),save:document.getElementById("saveBtn"),addN:document.getElementById("addNewsBtn"),delN:document.getElementById("deleteNewsBtn"),style:document.getElementById("dynamicTickerStyles"),statP:document.getElementById("statusPanel"),statD:document.getElementById("statusDataContainer"),lastEd:document.getElementById("lastEditedTime")};
const timeAgo=e=>{if(!e)return{text:"Sin fecha",diff:-1};const t=Date.now()-new Date(e).getTime();if(t<0)return{text:"Ahora mismo",diff:0};const a=Math.floor(t/1e3),n=Math.floor(a/60),o=Math.floor(n/60),s=Math.floor(o/24);return{text:s>=30?`hace ${Math.floor(s/30)} meses`:s>=7?`hace ${Math.floor(s/7)} sem.`:s>=2?`hace ${s} dÃ­as`:1===s?"hace 1 dÃ­a":o>=2?`hace ${o} horas`:1===o?"hace 1 hora":n>=1?`hace ${n} min.`:"hace momentos",diff:t,date:new Date(e)}};
async function fetchRates(){try{if(Date.now()-(new Date(status.divisa_edited_at||0).getTime())<CACHE_MS)return;const e=await fetch("https://corsproxy.io/?"+encodeURIComponent(API_URL),{headers:{Authorization:`Bearer ${API_TOKEN}`,"Content-Type":"application/json"}});if(!e.ok)throw 0;const t=await e.json(),a=(t.tasas?.USD||t.USD||0).toFixed(0),n=(t.tasas?.EUR||t.tasas?.ECU||t.EUR||t.ECU||0).toFixed(0);if("0"!==a&&"0"!==n){const e=new Date().toISOString();status={...status,dollar_cup:a,euro_cup:n,divisa_edited_at:e},renderStatus(status,admin),await supabase.from("status_data").update({dollar_cup:a,euro_cup:n,divisa_edited_at:e}).eq("id",1)}}catch(e){console.error("API Error")}}
function updateAdminUI(e){admin=e,DOM.body.classList.toggle("admin-mode",e),DOM.adminP.style.display=e?"flex":"none",DOM.msg.textContent=e?"Â¡ðŸ”´ EDITA CON RESPONSABILIDAD!":"Accede a modo ediciÃ³n...",DOM.msg.style.color=e?"#0d9488":"var(--color-texto-principal)",DOM.admBtn.textContent=e?"ðŸ›‘ SALIR MODO EDICIÃ“N":"ðŸ›¡ï¸ ACTIVAR MODO EDICIÃ“N",DOM.admBtn.style.backgroundColor=e?"var(--acento-rojo)":"#4f46e5",toggleEditing(e),DOM.statP.classList.toggle("admin-mode",e),renderStatus(status,e)}
function createCardHTML(e,t){let a="",n="",o="background:white",s="Actualizado",r="Sin editar";if(e.last_edited_timestamp){const{text:i,diff:d}=timeAgo(e.last_edited_timestamp);r=i,d>=0&&d<RECENT_MS?(a="card-recent",n='<div class="card-label" style="background:var(--acento-rojo);color:#fff;display:block">!EDITADO RECIENTEMENTEÂ¡</div>',o="background:var(--tiempo-panel-rojo);color:var(--acento-rojo)",s=""):d>=OLD_MS&&(a="card-old",n='<div class="card-label" style="background:var(--acento-cian);color:var(--color-texto-principal);display:block">Editado hace tiempo</div>',o="background:var(--tiempo-panel-cian);color:var(--acento-cian)",s="")}return`<div class="card ${a}" data-index="${t}" data-id="${e.id}">${n}<span class="emoji">${e.emoji}</span><h3>${e.titulo}</h3><div class="card-content"><p>${e.contenido}</p></div><div class="card-time-panel" data-id="${e.id}" style="${o}"><strong>${s}</strong> (${r})</div></div>`}
function toggleEditing(e){document.querySelectorAll(".card").forEach(t=>{const a=currentData[t.dataset.index],n=t.querySelector(".card-content");if(e){t.removeEventListener("click",toggleTimePanel),t.classList.remove("card-recent","card-old"),t.style.background="#fff",t.style.boxShadow="none",t.style.border="1px solid #4f46e5",t.querySelector(".card-time-panel").style.display="none",t.querySelector(".emoji").remove(),t.querySelector("h3").remove(),t.querySelector("p").remove();const o=document.createElement("input");o.className="editable-emoji",o.value=a.emoji,o.maxLength=2,t.prepend(o);const s=document.createElement("input");s.className="editable-title",s.value=a.titulo,t.insertBefore(s,o.nextSibling);const r=document.createElement("textarea");r.className="editable-content",r.value=a.contenido,n.appendChild(r)}else{t.querySelector("input").remove(),t.querySelector(".editable-title").remove(),t.querySelector("textarea").remove();const e=document.createElement("span");e.className="emoji",e.textContent=a.emoji,t.prepend(e);const o=document.createElement("h3");o.textContent=a.titulo,t.insertBefore(o,e.nextSibling);const s=document.createElement("p");s.textContent=a.contenido,n.appendChild(s);t.style="",t.querySelector(".card-time-panel").style.display="block",t.addEventListener("click",toggleTimePanel)}})}
function toggleTimePanel(e){if(admin)return;const t=e.currentTarget;document.querySelectorAll(".card").forEach(e=>e!==t&&e.classList.remove("show-time-panel")),t.classList.toggle("show-time-panel")&&setTimeout(()=>t.classList.remove("show-time-panel"),PANEL_MS)}
async function loadNews(){const{data:e}=await supabase.from("noticias").select("id,text,timestamp").order("timestamp",{ascending:!1});if(!e)return;const t=Date.now()-RECENT_MS,a=e.filter(e=>new Date(e.timestamp).getTime()>t);currentNews=a;const n=a.length?a.map(e=>`<span class="news-item">${(e=>e.replace(/(\b(https?:\/\/|www\.)[^\s]*)/g,e=>`<a href="${e.startsWith("http")?e:"http://"+e}" target="_blank">${e}</a>`))(e.text)} <small>(${timeAgo(e.timestamp).text})</small></span>`).join('<span class="news-item"> | </span>'):"Sin Noticias recientes... || ðŸ›¡ Activa el modo ediciÃ³n para publicar";DOM.newsC.innerHTML=a.length?`${n}<span class="news-item"> | </span>${n}`:n.repeat(2),DOM.news.style.display="flex";const o=DOM.newsC.scrollWidth/2;DOM.style.innerHTML=`@keyframes m{0%{transform:translateX(0)}100%{transform:translateX(-${o}px)}}`,DOM.newsC.style.animation=a.length?`m ${o/50}s linear infinite`:"ticker-move-static 15s linear infinite"}
function createCommentHTML(e,t){const a=`hsl(${e.name.split("").reduce((e,t)=>e+t.charCodeAt(0),0)%360},70%,50%)`;return`<div class="comment-item ${e.parent_id?"reply-style":""}" data-comment-id="${e.id}" style="--comment-color:${a}"><strong class="comment-name">${e.name} dijo:</strong><div class="comment-content">${e.text}</div><div class="comment-actions"><button class="like-button ${t?"liked":""}" data-id="${e.id}"><span class="heart">â™¥</span></button><span class="like-count" data-counter-id="${e.id}">${e.likes_count||0}</span>${e.parent_id?"":`<span class="reply-form-toggle" data-id="${e.id}">Responder</span>`}<span class="comment-date">${new Date(e.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}</span></div>${e.parent_id?"":`<div class="reply-form" data-reply-to="${e.id}"><input class="reply-name" placeholder="Nombre"><textarea class="reply-text" placeholder="Respuesta"></textarea><button class="publish-reply-btn" data-parent-id="${e.id}">Enviar</button></div><div class="replies-container" data-parent-of="${e.id}"></div>`}</div>`}
async function loadComments(){const[e,t]=await Promise.all([supabase.from("comentarios").select("*").order("timestamp",{ascending:!1}),supabase.from("likes").select("comment_id").eq("user_web_id",userWebId)]);if(e.error)return DOM.commC.innerHTML="Error loading.";const a=new Map();t.data?.forEach(e=>a.set(e.comment_id,!0));const n=e.data.filter(e=>!e.parent_id);if(!n.length)return DOM.commC.innerHTML='<p style="text-align:center;color:#888">SÃ© el primero en comentar.</p>';DOM.commC.innerHTML=n.map(e=>createCommentHTML(e,a.get(e.id))).join(""),n.forEach(t=>{const n=e.data.filter(e=>e.parent_id===t.id).sort((e,t)=>new Date(e.timestamp)-new Date(t.timestamp));if(n.length){const e=document.querySelector(`.replies-container[data-parent-of="${t.id}"]`);e.innerHTML=n.map(e=>`<div class="reply-item">${createCommentHTML(e,a.get(e.id))}</div>`).join(""),n.length>1&&((n=document.createElement("span")).className="reply-toggle",n.textContent="Ver respuestas...",n.onclick=t=>{t.target.closest(".replies-container").classList.add("expanded"),t.target.remove()},e.appendChild(n))}}),document.querySelectorAll(".reply-form-toggle").forEach(e=>e.onclick=t=>{const a=document.querySelector(`.reply-form[data-reply-to="${t.target.dataset.id}"]`);document.querySelectorAll(".reply-form").forEach(e=>e!==a&&(e.style.display="none")),a.style.display="block"===a.style.display?"none":"block"}),document.querySelectorAll(".publish-reply-btn").forEach(e=>e.onclick=async t=>{const a=t.target.closest(".reply-form"),n=a.querySelector(".reply-name").value,o=a.querySelector(".reply-text").value;n&&o&&(t.target.disabled=!0,await supabase.from("comentarios").insert([{name:n,text:o,parent_id:t.target.dataset.parentId}]),loadComments(),t.target.disabled=!1)}),document.querySelectorAll(".like-button").forEach(e=>e.onclick=async t=>{const a=t.currentTarget,n=a.dataset.id,o=a.classList.contains("liked"),s=document.querySelector(`.like-count[data-counter-id="${n}"]`);a.disabled=!0,o?(await supabase.from("likes").delete().eq("comment_id",n).eq("user_web_id",userWebId),await supabase.rpc("decrement_likes",{row_id:n}),s.textContent=Math.max(0,+s.textContent-1),a.classList.remove("liked")):(await supabase.from("likes").insert([{comment_id:n,user_web_id:userWebId}]).then(({error:e})=>{e&&"23505"!==e.code||(supabase.rpc("increment_likes",{row_id:n}),s.textContent=+s.textContent+1,a.classList.add("liked"))})),a.disabled=!1})}
function renderStatus(e,t){DOM.lastEd.innerHTML=`Ãšltima ediciÃ³n:<br>${timeAgo(e.deficit_edited_at).text}${t?"":`<br><small style="color:#8d99ae">Divisas: ${timeAgo(e.divisa_edited_at).text}</small>`}`,DOM.statD.innerHTML=t?`<div class="status-item"><span class="label">Deficit:</span><input id="editDeficit" value="${e.deficit_mw||""}"></div><div class="status-item"><span class="label">USD:</span><input value="${e.dollar_cup}" disabled></div><div class="status-item"><span class="label">EUR:</span><input value="${e.euro_cup}" disabled></div>`:`<div class="status-item deficit"><span class="label">ðŸ”Œ DÃ©ficit:</span><span class="value">${e.deficit_mw||"---"}</span></div><div class="status-item divisa"><span class="label">ðŸ’µ USD:</span><span class="value">${e.dollar_cup||"---"}</span></div><div class="status-item divisa"><span class="label">ðŸ’¶ EUR:</span><span class="value">${e.euro_cup||"---"}</span></div>`}
async function loadStatus(){const{data:e}=await supabase.from("status_data").select("*").single();e&&(status={...status,...e},renderStatus(status,admin),fetchRates())}
DOM.admBtn.onclick=()=>{admin?confirm("Â¿Terminar?")&&(updateAdminUI(!1),loadData(),loadStatus()):(updateAdminUI(!0),alert("Â¡ðŸ”´ EDITA CON RESPONSABILIDAD!"))};
DOM.save.onclick=async()=>{if(!admin)return;const e=document.getElementById("editDeficit").value,t=[];document.querySelectorAll(".card").forEach(e=>{const a=e.dataset.index,n=e.querySelector(".editable-emoji").value,o=e.querySelector(".editable-title").value,s=e.querySelector(".editable-content").value;(s!==currentData[a].contenido||o!==currentData[a].titulo||n!==currentData[a].emoji)&&t.push(supabase.from("items").update({emoji:n,titulo:o,contenido:s,last_edited_timestamp:new Date().toISOString()}).eq("id",e.dataset.id))}),e!==status.deficit_mw&&t.push(supabase.from("status_data").update({deficit_mw:e,deficit_edited_at:new Date().toISOString()}).eq("id",1));t.length?(await Promise.all(t),alert("âœ… Guardado."),location.reload()):alert("Sin cambios.")};
DOM.addN.onclick=async()=>{if(!admin)return;const e=prompt("Noticia:");e&&confirm("Â¿Publicar?")&&(await supabase.from("noticias").insert([{text:e}]),loadNews())};
DOM.delN.onclick=async()=>{if(!admin||!currentNews.length)return;const e=prompt(`Eliminar:\n${currentNews.map((e,t)=>`${t+1}. ${e.text}`).join("\n")}`)-1;currentNews[e]&&confirm("Â¿Eliminar?")&&(await supabase.from("noticias").delete().eq("id",currentNews[e].id),loadNews())};
DOM.pubBtn.onclick=async()=>{const e=DOM.cName.value,t=DOM.cText.value;e&&t&&(DOM.pubBtn.disabled=!0,await supabase.from("comentarios").insert([{name:e,text:t}]),DOM.cName.value="",DOM.cText.value="",loadComments(),alert("Publicado"),DOM.pubBtn.disabled=!1)};
async function loadData(){const{data:e}=await supabase.from("items").select("*").order("id");e&&(currentData=e,DOM.cont.innerHTML=e.map(createCardHTML).join(""),document.querySelectorAll(".card").forEach(e=>e.onclick=toggleTimePanel))}
document.addEventListener("DOMContentLoaded",()=>{document.getElementById("fecha-actualizacion").textContent=new Date().toLocaleDateString(),(async()=>{const e=localStorage.getItem("lastView");(!e||Date.now()-e>864e5)&&(await supabase.from("page_views").insert({}),localStorage.setItem("lastView",Date.now()));const t=new Date();t.setDate(t.getDate()-1);const{count:a}=await supabase.from("page_views").select("*",{count:"exact",head:!0}).gt("created_at",t.toISOString());document.getElementById("viewCounter").textContent=`ðŸ‘€ ${a||0} vistas (24h)`})(),loadData(),loadNews(),loadComments(),loadStatus()});
